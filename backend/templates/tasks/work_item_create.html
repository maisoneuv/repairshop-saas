{% extends "base.html" %}
{% load tailwind_filters %}


{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.5"></script>


    <a href = "{% url 'tasks:work_item_list' %}"> go back </a>
    <hr />
    <div class=" grid grid-cols-3 mt-2">
        <div class="col-span-2 border border-gray-300 rounded-lg mx-4 my-2 p-4 shadow w-3/5 mx-auto">
            <h1 class="text-base/5 font-semibold text-gray-900"> Create new item</h1>
            <div class="mt-4 border-t border-gray-100 m-1 p-2 text-sm">
                {% include 'tasks/create_work_item.html' %}
            </div>
        </div>
<!--        customer devices-->
        <div class="col-span-1  ">
            <div class="grid grid-rows-3 gap-1 h-full">
                <div class="row-span-1 border border-gray-300 rounded-lg mx-4 ml-1 p-3">
                    <h3 class="text-base/5 font-semibold text-gray-800">Customer devices</h3>
                    <div class="mt-4 border-t border-gray-100">
                        {% include 'customers/asset_list.html' with tasks=tasks %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
<script>

{% comment %} $(document).ready(function() {
    $("#id_customer").select2();
}); {% endcomment %}

document.addEventListener("DOMContentLoaded", function() {
    function setupAutocomplete(fieldId, url) {
        return new TomSelect("#" + fieldId, {
            valueField: "id",
            labelField: "text",
            searchField: "text",
            maxItems: 1,
            create: true,
            persist: false,

            placeholder: "Search for a customer...",
            load: function(query, callback) {
                if (!query.length) return callback();

                fetch(url + "?q=" + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => callback(data))
                    .catch(() => callback());
            }
        });
    }

    let phoneSelect = setupAutocomplete("customer-phone", "{% url 'customers:customer-phone-autocomplete' %}");
    let emailSelect = setupAutocomplete("customer-email", "{% url 'customers:customer-email-autocomplete' %}");
    let nameSelect = setupAutocomplete("customer-name", "{% url 'customers:customer-name-autocomplete' %}");

    phoneSelect.on("change", function(value) {
        console.log("Selected phone value:", value);
        if (!value) return;

        fetch("{% url 'customers:customer-details' %}?id=" + encodeURIComponent(value))
            .then(response => response.json())
            .then(data => {
                console.log("Customer data received:", data);
                
                if (data.success) {
                    nameSelect.addOption({ id: value, text: data.name });
                    nameSelect.setValue(data.name);

                    emailSelect.addOption({ id: value, text: data.email });
                    emailSelect.setValue(value);
                    console.log(nameSelect.value)

                }
            })
            .catch(error => console.error("Error fetching customer details:", error));
    });

});

</script>
{% endblock %}